<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ„›è»Š V6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1976d2; --bg: #f5f5f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { color: #333; margin: 0 0 15px 0; font-size: 1.1rem; text-align: center; }
        label { display: block; margin: 10px 0 5px; font-weight: 600; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        
        /* çµ±è¨ˆå€å¡Š */
        .stats-box { text-align: center; color: #d32f2f; font-weight: bold; margin-top: 10px; font-size: 14px; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .log-item { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-left { display: flex; flex-direction: column; }
        .log-date { font-size: 12px; color: #888; }
        .log-title { font-weight: bold; font-size: 15px; }
        .log-cost { color: #d32f2f; font-weight: bold; }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-top: 3px; display: inline-block; background: #e3f2fd; color: #1976d2; }
    </style>
</head>
<body>

<div class="card">
    <canvas id="fuelChart" style="height: 200px; width: 100%;"></canvas>
    <div id="monthStats" class="stats-box">è¼‰å…¥ä¸­...</div>
</div>

<div class="card">
    <h2>ğŸ“ æ–°å¢ç´€éŒ„</h2>
    <input type="date" id="date">
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label>é¡åˆ¥</label>
            <select id="category" onchange="toggleFields()">
                <option value="fuel">â›½ åŠ æ²¹</option>
                <option value="maint">ğŸ› ï¸ ç¶­ä¿®</option>
            </select>
        </div>
        <div style="flex:1;">
            <label>é‡Œç¨‹ (Km)</label>
            <input type="number" id="km" inputmode="numeric">
        </div>
    </div>

    <div id="fuelDiv">
        <label>å…¥æ²¹é‡ (L)</label>
        <input type="number" id="amount" step="0.01" inputmode="decimal">
    </div>
    <div id="maintDiv" style="display:none;">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="maintName">
    </div>
    
    <label>æ”¯å‡ºé‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric">
    
    <button class="btn" id="saveBtn" onclick="uploadData()">å„²å­˜ä¸¦åŒæ­¥</button>
</div>

<div class="card">
    <h2>ğŸ” æ­·å²ç´€éŒ„</h2>
    <input type="text" id="searchInput" placeholder="æœå°‹æ—¥æœŸæˆ–é …ç›®..." onkeyup="filterLogs()" style="margin-bottom:10px;">
    <div id="logList"></div>
</div>

<script>
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDMf6QwzXaNHP2iKWd0gAlOhGsI_eGhT1U1F8Vvo_adZ94AXfQW9gsG4d7VauNBBtE/exec"; 

    let allLogs = [];
    let myChart = null;

    document.getElementById('date').valueAsDate = new Date();
    
    // å•Ÿå‹•æ™‚è®€å–æ•¸æ“š
    window.onload = loadData;

    function toggleFields() {
        const isFuel = document.getElementById('category').value === 'fuel';
        document.getElementById('fuelDiv').style.display = isFuel ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = isFuel ? 'none' : 'block';
    }

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            
            // é€™è£¡å°‡è³‡æ–™åè½‰ï¼šè®“æœ€æ–°çš„æ’åœ¨æœ€ä¸Šé¢ (çµ¦åˆ—è¡¨ç”¨)
            allLogs = data.reverse(); 
            
            renderList(allLogs);
            renderChart(allLogs); // åœ–è¡¨å‡½æ•¸å…§éƒ¨æœƒå†è™•ç†é †åº
            updateMonthStats(allLogs);
        } catch (e) {
            console.error(e);
            document.getElementById('monthStats').innerText = "é€£ç·šå¤±æ•—";
        }
    }

    function updateMonthStats(data) {
        if (data.length > 0) {
            // å› ç‚º allLogs å·²ç¶“åè½‰ç‚ºæœ€æ–°åœ¨ index 0
            // ç›´æ¥è®€å–æœ€æ–°ä¸€ç­†çš„ monthlyTotal (é€™æ˜¯å¾Œå°ç®—å¥½çš„çµæœ)
            const latest = data[0];
            document.getElementById('monthStats').innerText = 
                `ğŸ“… ${latest.date.substring(0,7)} ç´¯è¨ˆæ”¯å‡ºï¼š$${latest.monthlyTotal}`;
        } else {
            document.getElementById('monthStats').innerText = "å°šç„¡è³‡æ–™";
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('fuelChart').getContext('2d');
        
        // 1. è¤‡è£½è³‡æ–™ä¸¦åè½‰å›ã€ŒèˆŠ -> æ–°ã€ (çµ¦åœ–è¡¨æ™‚é–“è»¸ç”¨)
        const chartData = [...data].reverse();
        
        // 2. åªæŠ“å–æœ‰æ²¹è€— (kpl) çš„æ•¸æ“š
        const fuelLogs = chartData.filter(d => d.kpl && d.kpl !== "");

        const labels = fuelLogs.map(d => d.date.substring(5)); // å– MM-DD
        const values = fuelLogs.map(d => d.kpl);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Km/L',
                    data: values,
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
            }
        });
    }

    function renderList(data) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        if (data.length === 0) return list.innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>ç„¡è³‡æ–™</div>";

        data.forEach(log => {
            const isFuel = log.category === 'åŠ æ²¹';
            const title = isFuel ? 'â›½ åŠ æ²¹' : `ğŸ› ï¸ ${log.name}`;
            const sub = isFuel ? `${log.kpl} Km/L` : '';
            
            list.innerHTML += `
                <div class="log-item">
                    <div class="log-left">
                        <span class="log-date">${log.date}</span>
                        <span class="log-title">${title}</span>
                        ${sub ? `<span class="tag">${sub}</span>` : ''}
                    </div>
                    <div class="log-right">
                        <div class="log-cost">$${log.cost}</div>
                    </div>
                </div>`;
        });
    }

    function filterLogs() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allLogs.filter(l => 
            l.date.includes(key) || l.category.includes(key) || l.name.toLowerCase().includes(key)
        );
        renderList(filtered);
    }

    async function uploadData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value, // Eæ¬„
            cost: document.getElementById('cost').value,     // Fæ¬„
            name: document.getElementById('maintName').value
        };

        if(!data.km || !data.cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

        btn.disabled = true;
        btn.innerText = "â³ å„²å­˜ä¸­...";

        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        });

        alert("âœ… æˆåŠŸï¼");
        
        document.getElementById('cost').value = "";
        document.getElementById('amount').value = "";
        btn.innerText = "å„²å­˜ä¸¦åŒæ­¥";
        btn.disabled = false;
        
        setTimeout(loadData, 1500); // ç¨ç­‰ä¸€ä¸‹å†è®€å–
    }
</script>
</body>
</html>
