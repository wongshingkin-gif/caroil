<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯æ±½è»Šç®¡å®¶ PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #1a73e8; }
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { color: var(--p); text-align: center; margin-top: 0; font-size: 1.2rem; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .status { text-align: center; margin-top: 10px; color: #666; font-size: 12px; }
        .chart-container { position: relative; height: 200px; width: 100%; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“ˆ æ²¹è€—è¶¨å‹¢åˆ†æ (Km/L)</h2>
    <div class="chart-container">
        <canvas id="fuelChart"></canvas>
    </div>
    <div id="summary" style="text-align:center; font-size: 14px; margin-top: 10px; font-weight: bold; color: #d93025;"></div>
</div>

<div class="card">
    <h2>ğŸš— æ•¸æ“šè¼¸å…¥</h2>
    <label>æ—¥æœŸ</label>
    <input type="date" id="date">
    <label>é¡åˆ¥</label>
    <select id="category" onchange="toggleFields()">
        <option value="fuel">â›½ åŠ æ²¹</option>
        <option value="maint">ğŸ› ï¸ ç¶­ä¿®/ä¿é¤Š</option>
    </select>
    <label>ç¸½é‡Œç¨‹ (Km)</label>
    <input type="number" id="km" inputmode="numeric">
    <div id="fuelDiv"><label>å…¬å‡ (L)</label><input type="number" id="amount" step="0.01" inputmode="decimal"></div>
    <div id="maintDiv" style="display:none;"><label>é …ç›®</label><input type="text" id="maintName"></div>
    <label>é‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric">
    <button class="btn" onclick="uploadData()">å„²å­˜ä¸¦æ›´æ–°åœ–è¡¨</button>
    <div id="status" class="status">æ­£åœ¨è¼‰å…¥é›²ç«¯æ•¸æ“š...</div>
</div>

<script>
    const SCRIPT_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€";
    let myChart;

    document.getElementById('date').valueAsDate = new Date();

    // é é¢è¼‰å…¥æ™‚å…ˆæŠ“å–ä¸€æ¬¡åœ–è¡¨æ•¸æ“š
    window.onload = loadChartData;

    function toggleFields() {
        const cat = document.getElementById('category').value;
        document.getElementById('fuelDiv').style.display = (cat === 'fuel') ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = (cat === 'maint') ? 'block' : 'none';
    }

    async function loadChartData() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            if (data.length === 0) return;

            // è™•ç†åœ–è¡¨æ•¸æ“šï¼šéæ¿¾å‡ºæœ‰æ²¹è€—ç´€éŒ„çš„
            const fuelLogs = data.filter(d => d.kpl !== "");
            const labels = fuelLogs.map(d => d.date.split('T')[0].substring(5)); // é¡¯ç¤º MM-DD
            const values = fuelLogs.map(d => d.kpl);

            // æ›´æ–°æœˆé–‹æ”¯æ–‡å­—
            const lastEntry = data[data.length - 1];
            document.getElementById('summary').innerText = `æœ¬æœˆç´¯è¨ˆæ”¯å‡ºï¼š$${lastEntry.monthlyTotal}`;

            const ctx = document.getElementById('fuelChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Km/L',
                        data: values,
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false } }
                }
            });
            document.getElementById('status').innerText = "é›²ç«¯åŒæ­¥å·²å°±ç·’";
        } catch (e) {
            console.error(e);
        }
    }

    async function uploadData() {
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value,
            cost: document.getElementById('cost').value,
            name: (document.getElementById('category').value === 'fuel') ? 'åŠ æ²¹' : document.getElementById('maintName').value
        };

        if (!data.km || !data.cost) return alert("è«‹å®Œæ•´è¼¸å…¥ï¼");

        document.getElementById('status').innerText = "ğŸš€ åŒæ­¥ä¸­...";
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        });

        alert("å·²å­˜å…¥é›²ç«¯ï¼");
        // é‡æ–°è¼‰å…¥åœ–è¡¨ä»¥é¡¯ç¤ºæœ€æ–°æ•¸æ“š
        setTimeout(loadChartData, 2000); 
        document.getElementById('km').value = "";
        document.getElementById('amount').value = "";
        document.getElementById('cost').value = "";
    }
</script>
</body>
</html>
