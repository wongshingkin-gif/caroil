<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simon's Car Info</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Simon Car">
    <link rel="apple-touch-icon" href="Gemini_Generated_Image_ikaqyzikaqyzikaq.png">

    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Š */
        :root { --primary: #1976d2; --bg: #f5f5f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; -webkit-tap-highlight-color: transparent; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px; }
        h2 { color: #333; margin: 0 0 15px 0; font-size: 1.2rem; text-align: center; font-weight: 700; }
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 14px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        .chart-container { position: relative; height: 240px; width: 100%; }
        .stats-box { text-align: center; color: #d32f2f; font-weight: bold; margin-top: 12px; font-size: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .log-list { max-height: 320px; overflow-y: auto; }
        .log-item { padding: 14px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 3px 8px; border-radius: 12px; margin-top: 4px; display: inline-block; font-weight: 600; }
        .tag-fuel { background: #e3f2fd; color: #1976d2; }
        .tag-maint { background: #fff3e0; color: #e65100; }
        .log-cost { color: #d32f2f; font-weight: 700; font-size: 16px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Simon's Car Stat</h2>
    <div class="chart-container"><canvas id="fuelChart"></canvas></div>
    <div id="monthStats" class="stats-box">è¼‰å…¥æ•¸æ“šä¸­...</div>
</div>

<div class="card">
    <h2>ğŸ“ æ–°å¢ç´€éŒ„</h2>
    <input type="date" id="date">
    <div style="display:flex; gap:12px; margin-top: 10px;">
        <div style="flex:1;">
            <label>é¡åˆ¥</label>
            <select id="category" onchange="toggleFields()">
                <option value="fuel">â›½ åŠ æ²¹</option>
                <option value="maint">ğŸ› ï¸ ç¶­ä¿®</option>
            </select>
        </div>
        <div style="flex:1;">
            <label>é‡Œç¨‹ (Km)</label>
            <input type="number" id="km" inputmode="numeric">
        </div>
    </div>
    <div id="fuelDiv">
        <label>å…¥æ²¹é‡ (L)</label>
        <input type="number" id="amount" step="0.01" inputmode="decimal">
    </div>
    <div id="maintDiv" style="display:none;">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="maintName">
    </div>
    <label>æ”¯å‡ºé‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric">
    <button class="btn" id="saveBtn" onclick="uploadData()">å„²å­˜ä¸¦åŒæ­¥</button>
</div>

<div class="card">
    <h2>ğŸ” æ­·å²ç´€éŒ„</h2>
    <input type="text" id="searchInput" placeholder="æœå°‹..." onkeyup="filterLogs()" style="width:100%; margin-bottom:10px;">
    <div id="logList" class="log-list"></div>
</div>

<script>
    // âš ï¸ é€™è£¡è¦æ›æˆæ‚¨çš„ GAS ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXUero9zroT-VsQJp5GWANWZgDqD3OmglfcB6V0O9KzSqhmaf35eWsTCj2RrAwqNAZ/exec"; 

    // 2. è¨»å†Š Service Worker (PWA å¿…éœ€)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    let allLogs = [];
    let myChart = null;
    document.getElementById('date').valueAsDate = new Date();
    window.onload = loadData;

    function toggleFields() {
        const isFuel = document.getElementById('category').value === 'fuel';
        document.getElementById('fuelDiv').style.display = isFuel ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = isFuel ? 'none' : 'block';
    }

    async function loadData() {
        try {
            // å¾ GitHub Pages å‘¼å« GASï¼Œå¿…é ˆè™•ç†è·¨åŸŸ
            const res = await fetch(SCRIPT_URL);
            const data = await res.json(); // å› ç‚º doGet ç¾åœ¨å›å‚³ JSON
            allLogs = data.reverse(); 
            renderList(allLogs);
            renderChart(allLogs); 
            updateMonthStats(allLogs);
        } catch (e) {
            console.error(e);
            document.getElementById('monthStats').innerText = "é€£ç·šå¤±æ•—";
        }
    }

    function updateMonthStats(data) {
        if (data.length > 0) {
            const latest = data[0]; 
            document.getElementById('monthStats').innerHTML = 
                `ğŸ“… ${latest.date.substring(0, 7)} ç´¯è¨ˆæ”¯å‡ºï¼š<span style="font-size:1.2em">$${latest.monthlyTotal}</span>`;
        } else {
            document.getElementById('monthStats').innerText = "å°šç„¡è³‡æ–™";
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('fuelChart').getContext('2d');
        const chartData = [...data].reverse().filter(d => d.kpl && d.kpl !== "");
        const labels = chartData.map(d => d.date.substring(5));
        const values = chartData.map(d => d.kpl);

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ²¹è€— (Km/L)',
                    data: values,
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderList(data) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        if (data.length === 0) return list.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>ç„¡è³‡æ–™</div>";
        data.forEach(log => {
            const isFuel = log.category === 'åŠ æ²¹';
            const title = isFuel ? 'â›½ åŠ æ²¹' : `ğŸ› ï¸ ${log.name}`;
            const tag = isFuel ? `<span class="tag tag-fuel">${log.kpl} Km/L</span>` : `<span class="tag tag-maint">ç¶­ä¿®</span>`;
            list.innerHTML += `
                <div class="log-item">
                    <div class="log-left"><span class="log-date">${log.date}</span><span class="log-title">${title}</span><div>${tag}</div></div>
                    <div class="log-right"><div class="log-cost">$${log.cost}</div><div style="font-size:12px;color:#aaa;">${log.km} km</div></div>
                </div>`;
        });
    }

    function filterLogs() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allLogs.filter(l => l.date.includes(key) || l.category.includes(key) || l.name.toLowerCase().includes(key));
        renderList(filtered);
    }

    async function uploadData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value,
            cost: document.getElementById('cost').value,
            name: document.getElementById('maintName').value
        };

        if(!data.km || !data.cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

        btn.disabled = true;
        btn.innerText = "â³ é›²ç«¯åŒæ­¥ä¸­...";

        // å› ç‚ºæ˜¯åœ¨ GitHubï¼Œå¿…é ˆç”¨ no-cors
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // âš ï¸ é—œéµè¨­å®š
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        alert("âœ… ç´€éŒ„æˆåŠŸï¼");
        document.getElementById('cost').value = "";
        document.getElementById('amount').value = "";
        btn.innerText = "å„²å­˜ä¸¦åŒæ­¥";
        btn.disabled = false;
        setTimeout(loadData, 1500);
    }
</script>
</body>
</html>

