<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯æ±½è»Šç®¡å®¶ V5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #1a73e8; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .card { background: white; padding: 18px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 16px; }
        h2 { color: #333; text-align: center; margin: 0 0 15px 0; font-size: 1.1rem; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        label { display: block; margin: 10px 0 5px; font-weight: 600; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; background: #fff; }
        
        .btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn:active { opacity: 0.8; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .log-list { max-height: 350px; overflow-y: auto; }
        .log-item { padding: 12px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .log-left { display: flex; flex-direction: column; }
        .log-date { font-size: 12px; color: #888; margin-bottom: 3px; }
        .log-title { font-weight: bold; font-size: 15px; color: #333; }
        .log-right { text-align: right; }
        .log-cost { color: #d93025; font-weight: bold; font-size: 15px; }
        .log-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        .tag-fuel { background: #e8f0fe; color: #1a73e8; }
        .tag-maint { background: #fef7e0; color: #b06000; }

        /* çµ±è¨ˆæ‘˜è¦ */
        .stats-box { background: #fff0f0; color: #c0392b; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <canvas id="fuelChart" style="height: 200px; width: 100%;"></canvas>
    <div id="monthStats" class="stats-box">è¼‰å…¥æ•¸æ“šä¸­...</div>
</div>

<div class="card">
    <h2>ğŸ“ æ–°å¢ç´€éŒ„</h2>
    <input type="date" id="date">
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label>é¡åˆ¥</label>
            <select id="category" onchange="toggleFields()">
                <option value="fuel">â›½ åŠ æ²¹</option>
                <option value="maint">ğŸ› ï¸ ç¶­ä¿®</option>
            </select>
        </div>
        <div style="flex:1;">
            <label>é‡Œç¨‹ (Km)</label>
            <input type="number" id="km" inputmode="numeric">
        </div>
    </div>

    <div id="fuelDiv"><label>å…¬å‡ (L)</label><input type="number" id="amount" step="0.01" inputmode="decimal"></div>
    <div id="maintDiv" style="display:none;"><label>é …ç›®åç¨±</label><input type="text" id="maintName"></div>
    
    <label>é‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric">
    
    <button class="btn" id="saveBtn" onclick="uploadData()">å„²å­˜ä¸¦åŒæ­¥</button>
</div>

<div class="card">
    <h2>ğŸ” æ­·å²ç´€éŒ„</h2>
    <input type="text" id="searchInput" placeholder="æœå°‹æ—¥æœŸã€é …ç›®..." onkeyup="filterLogs()" style="margin-bottom:10px;">
    <div id="logList" class="log-list"></div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è²¼ä¸Šæ–°çš„ GAS ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdVhe8tgT0Q_biHC7tiZItp6lfy2VQBzStc7i3jdgJQQsRTicSnG5mvfnbGkDPvjbp/exec"; 
    // ==========================================

    let allLogs = [];
    let myChart = null;

    document.getElementById('date').valueAsDate = new Date();
    window.onload = loadData;

    function toggleFields() {
        const isFuel = document.getElementById('category').value === 'fuel';
        document.getElementById('fuelDiv').style.display = isFuel ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = isFuel ? 'none' : 'block';
    }

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL);
            allLogs = await res.json();
            
            renderList(allLogs);
            renderChart(allLogs);
            updateMonthStats(allLogs);
        } catch (e) {
            console.error(e);
            document.getElementById('monthStats').innerText = "ç„¡æ³•é€£æ¥é›²ç«¯";
        }
    }

    // é¡¯ç¤ºæœ¬æœˆçµ±è¨ˆ (å–æœ€æ–°ä¸€ç­†è³‡æ–™çš„ monthlyTotal)
    function updateMonthStats(data) {
        if (data.length > 0) {
            // å› ç‚ºåˆ—è¡¨æ˜¯æ–°åˆ°èˆŠï¼Œæ‰€ä»¥ data[0] å°±æ˜¯æœ€æ–°çš„ä¸€ç­†
            const latest = data[0]; 
            document.getElementById('monthStats').innerText = 
                `ğŸ“… ${latest.date.substring(0,7)} ç´¯è¨ˆæ”¯å‡ºï¼š$${latest.monthlyTotal}`;
        } else {
            document.getElementById('monthStats').innerText = "å°šç„¡ç´€éŒ„";
        }
    }

    // æ¸²æŸ“åœ–è¡¨ (ä¿®å¾©ï¼šå°‡è³‡æ–™åè½‰å› èˆŠ->æ–°)
    function renderChart(data) {
        const ctx = document.getElementById('fuelChart').getContext('2d');
        
        // 1. è¤‡è£½ä¸€ä»½æ•¸æ“šä¸¦åè½‰ (è®Šæˆ æ™‚é–“ç”±èˆŠåˆ°æ–°)
        // 2. éæ¿¾å‡ºæœ‰ KPL æ²¹è€—æ•¸æ“šçš„
        const chartData = [...data].reverse().filter(d => d.kpl && d.kpl !== "");

        const labels = chartData.map(d => d.date.substring(5)); // å– MM-DD
        const values = chartData.map(d => d.kpl);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ²¹è€— (Km/L)',
                    data: values,
                    borderColor: '#1a73e8',
                    backgroundColor: 'rgba(26, 115, 232, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
            }
        });
    }

    // æ¸²æŸ“åˆ—è¡¨ (ä¿æŒ æ–°->èˆŠ)
    function renderList(data) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        
        if (data.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>ç„¡ç¬¦åˆè³‡æ–™</div>";
            return;
        }

        data.forEach(log => {
            const isFuel = log.category === 'åŠ æ²¹';
            const title = isFuel ? 'â›½ åŠ æ²¹' : `ğŸ› ï¸ ${log.name}`;
            const tagClass = isFuel ? 'tag-fuel' : 'tag-maint';
            const subInfo = isFuel ? `${log.kpl} Km/L` : '';
            
            list.innerHTML += `
                <div class="log-item">
                    <div class="log-left">
                        <span class="log-date">${log.date}</span>
                        <span class="log-title">${title}</span>
                        ${subInfo ? `<span class="log-tag ${tagClass}">${subInfo}</span>` : ''}
                    </div>
                    <div class="log-right">
                        <div class="log-cost">$${log.cost}</div>
                        <div style="font-size:12px; color:#aaa;">${log.km} km</div>
                    </div>
                </div>`;
        });
    }

    function filterLogs() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allLogs.filter(l => 
            l.date.includes(key) || 
            l.category.includes(key) || 
            l.name.toLowerCase().includes(key)
        );
        renderList(filtered);
    }

    async function uploadData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value,
            cost: document.getElementById('cost').value,
            name: document.getElementById('maintName').value
        };

        if(!data.km || !data.cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

        btn.disabled = true;
        btn.innerText = "â³ è™•ç†ä¸­...";

        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        });

        alert("âœ… å„²å­˜æˆåŠŸï¼");
        
        // æ¸…ç©ºä¸¦é‡æ•´
        document.getElementById('cost').value = "";
        document.getElementById('amount').value = "";
        btn.innerText = "å„²å­˜ä¸¦åŒæ­¥";
        btn.disabled = false;
        
        // å»¶é² 1.5 ç§’è®“ Google å¯«å…¥å®Œæˆå¾Œå†è®€å–
        setTimeout(loadData, 1500);
    }
</script>
</body>
</html>
