<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simon's Car Info</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <meta name="theme-color" content="#1976d2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Simon Car">

    <link rel="apple-touch-icon" href="https://github.com/wongshingkin-gif/caroil/blob/ada5c33ce9078002dcd4b64f67285f4085de3631/Gemini_Generated_Image_ikaqyzikaqyzikaq.png">
    <link rel="icon" type="image/png" href="https://github.com/wongshingkin-gif/caroil/blob/ada5c33ce9078002dcd4b64f67285f4085de3631/Gemini_Generated_Image_ikaqyzikaqyzikaq.png">

    <style>
        :root { --primary: #1976d2; --bg: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 15px; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px; }
        
        /* æ¨™é¡Œèˆ‡æ–‡å­— */
        h2 { color: #333; margin: 0 0 15px 0; font-size: 1.2rem; text-align: center; font-weight: 700; }
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 14px; color: #555; }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background-color: #fff; appearance: none; -webkit-appearance: none; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); }
        
        /* æŒ‰éˆ•å„ªåŒ– */
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: transform 0.1s, opacity 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* ğŸ“‰ åœ–è¡¨å®¹å™¨ (é˜²æ­¢æ‹‰é•·çš„æ ¸å¿ƒè¨­å®š) */
        .chart-container {
            position: relative;
            height: 240px; /* å›ºå®šé«˜åº¦ */
            width: 100%;
        }

        /* çµ±è¨ˆå€å¡Š */
        .stats-box { text-align: center; color: #d32f2f; font-weight: bold; margin-top: 12px; font-size: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        
        /* æœå°‹æ¡† */
        .search-wrapper { position: relative; margin-bottom: 10px; }
        .search-icon { position: absolute; right: 12px; top: 12px; color: #999; }

        /* åˆ—è¡¨æ¨£å¼ */
        .log-list { max-height: 320px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .log-item { padding: 14px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .log-item:last-child { border-bottom: none; }
        .log-left { display: flex; flex-direction: column; }
        .log-date { font-size: 12px; color: #888; margin-bottom: 4px; }
        .log-title { font-weight: bold; font-size: 15px; color: #333; }
        .tag { font-size: 11px; padding: 3px 8px; border-radius: 12px; margin-top: 4px; display: inline-block; font-weight: 600; }
        .tag-fuel { background: #e3f2fd; color: #1976d2; }
        .tag-maint { background: #fff3e0; color: #e65100; }
        .log-right { text-align: right; }
        .log-cost { color: #d32f2f; font-weight: 700; font-size: 16px; }
        .log-km { font-size: 12px; color: #aaa; margin-top: 2px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Simon's Car Stat</h2>
    <div class="chart-container">
        <canvas id="fuelChart"></canvas>
    </div>
    <div id="monthStats" class="stats-box">è¼‰å…¥æ•¸æ“šä¸­...</div>
</div>

<div class="card">
    <h2>ğŸ“ æ–°å¢ç´€éŒ„</h2>
    <input type="date" id="date">
    <div style="display:flex; gap:12px; margin-top: 10px;">
        <div style="flex:1;">
            <label>é¡åˆ¥</label>
            <select id="category" onchange="toggleFields()">
                <option value="fuel">â›½ åŠ æ²¹</option>
                <option value="maint">ğŸ› ï¸ ç¶­ä¿®</option>
            </select>
        </div>
        <div style="flex:1;">
            <label>é‡Œç¨‹ (Km)</label>
            <input type="number" id="km" inputmode="numeric" placeholder="ç›®å‰é‡Œç¨‹">
        </div>
    </div>

    <div id="fuelDiv">
        <label>å…¥æ²¹é‡ (L)</label>
        <input type="number" id="amount" step="0.01" inputmode="decimal" placeholder="å…¬å‡æ•¸">
    </div>
    <div id="maintDiv" style="display:none;">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="maintName" placeholder="ä¾‹å¦‚:æ›æ©Ÿæ²¹">
    </div>
    
    <label>æ”¯å‡ºé‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric" placeholder="ç¸½é‡‘é¡">
    
    <button class="btn" id="saveBtn" onclick="uploadData()">å„²å­˜ä¸¦åŒæ­¥</button>
</div>

<div class="card">
    <h2>ğŸ” æ­·å²ç´€éŒ„</h2>
    <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="æœå°‹æ—¥æœŸã€é …ç›® (å¦‚: æ©Ÿæ²¹)..." onkeyup="filterLogs()">
        <span class="search-icon">ğŸ”</span>
    </div>
    <div id="logList" class="log-list"></div>
</div>

<script>
    // ==========================================
    // âš ï¸ é€™è£¡éå¸¸é‡è¦ï¼è«‹è²¼ä¸Šä½ çš„ Google Apps Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDMf6QwzXaNHP2iKWd0gAlOhGsI_eGhT1U1F8Vvo_adZ94AXfQW9gsG4d7VauNBBtE/exec"; 
    // ==========================================

    let allLogs = [];
    let myChart = null;

    // è¨­å®šæ—¥æœŸé è¨­ç‚ºä»Šå¤©
    document.getElementById('date').valueAsDate = new Date();
    
    // ç¶²é è¼‰å…¥æ™‚åŸ·è¡Œ
    window.onload = loadData;

    // åˆ‡æ› åŠ æ²¹/ç¶­ä¿® é¡¯ç¤ºä¸åŒæ¬„ä½
    function toggleFields() {
        const isFuel = document.getElementById('category').value === 'fuel';
        document.getElementById('fuelDiv').style.display = isFuel ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = isFuel ? 'none' : 'block';
    }

    // å¾ Google Sheet è®€å–è³‡æ–™
    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            
            // å¾Œå°å›å‚³çš„æ˜¯ã€ŒèˆŠ -> æ–°ã€ï¼Œæˆ‘å€‘åè½‰æˆã€Œæ–° -> èˆŠã€çµ¦åˆ—è¡¨é¡¯ç¤º
            allLogs = data.reverse(); 
            
            renderList(allLogs);
            renderChart(allLogs); 
            updateMonthStats(allLogs);
        } catch (e) {
            console.error(e);
            document.getElementById('monthStats').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
        }
    }

    // æ›´æ–°æœ¬æœˆçµ±è¨ˆæ–‡å­—
    function updateMonthStats(data) {
        if (data.length > 0) {
            // å› ç‚ºåˆ—è¡¨å·²åè½‰ï¼Œæœ€æ–°çš„è³‡æ–™åœ¨ index 0
            const latest = data[0]; 
            const dateStr = latest.date.substring(0, 7); // å–å‡º YYYY-MM
            document.getElementById('monthStats').innerHTML = 
                `ğŸ“… ${dateStr} ç´¯è¨ˆæ”¯å‡ºï¼š<span style="font-size:1.2em">$${latest.monthlyTotal}</span>`;
        } else {
            document.getElementById('monthStats').innerText = "å°šç„¡è³‡æ–™";
        }
    }

    // ç¹ªè£½åœ–è¡¨
    function renderChart(data) {
        const ctx = document.getElementById('fuelChart').getContext('2d');
        
        // åœ–è¡¨éœ€è¦æ™‚é–“è»¸ã€Œç”±èˆŠåˆ°æ–°ã€ï¼Œæ‰€ä»¥æˆ‘å€‘æŠŠ data å†åè½‰ä¸€æ¬¡
        // ä¸¦åªç¯©é¸å‡ºæœ‰è¨ˆç®—å‡ºæ²¹è€— (KPL) çš„è³‡æ–™
        const chartData = [...data].reverse().filter(d => d.kpl && d.kpl !== "");

        const labels = chartData.map(d => d.date.substring(5)); // å– MM-DD
        const values = chartData.map(d => d.kpl);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ²¹è€— (Km/L)',
                    data: values,
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3 // ç·šæ¢å¹³æ»‘åº¦
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // é—œéµï¼šå¼·åˆ¶å¡«æ»¿å®¹å™¨ï¼Œä¸è®“åœ–è¡¨ç„¡é™æ‹‰é•·
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' Km/L';
                            }
                        }
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: false,
                        grid: { color: '#f0f0f0' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 6 }
                    } 
                }
            }
        });
    }

    // æ¸²æŸ“æ­·å²åˆ—è¡¨
    function renderList(data) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        
        if (data.length === 0) {
            list.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>ç„¡ç¬¦åˆè³‡æ–™</div>";
            return;
        }

        data.forEach(log => {
            const isFuel = log.category === 'åŠ æ²¹';
            const title = isFuel ? 'â›½ åŠ æ²¹' : `ğŸ› ï¸ ${log.name}`;
            const subTag = isFuel ? `<span class="tag tag-fuel">${log.kpl} Km/L</span>` : `<span class="tag tag-maint">ç¶­ä¿®</span>`;
            
            list.innerHTML += `
                <div class="log-item">
                    <div class="log-left">
                        <span class="log-date">${log.date}</span>
                        <span class="log-title">${title}</span>
                        <div>${subTag}</div>
                    </div>
                    <div class="log-right">
                        <div class="log-cost">$${log.cost}</div>
                        <div class="log-km">${log.km} km</div>
                    </div>
                </div>`;
        });
    }

    // æœå°‹åŠŸèƒ½
    function filterLogs() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allLogs.filter(l => 
            l.date.includes(key) || 
            l.category.includes(key) || 
            l.name.toLowerCase().includes(key)
        );
        renderList(filtered);
    }

    // ä¸Šå‚³è³‡æ–™
    async function uploadData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value,
            cost: document.getElementById('cost').value,
            name: document.getElementById('maintName').value
        };

        if(!data.km || !data.cost) return alert("è«‹è‡³å°‘è¼¸å…¥é‡Œç¨‹å’Œé‡‘é¡");

        btn.disabled = true;
        btn.innerText = "â³ é›²ç«¯åŒæ­¥ä¸­...";

        // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ (Google Script é™åˆ¶)
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        });

        alert("âœ… ç´€éŒ„æˆåŠŸï¼");
        
        // é‡ç½®è¼¸å…¥æ¡†
        document.getElementById('cost').value = "";
        document.getElementById('amount').value = "";
        if(data.category === 'maint') document.getElementById('maintName').value = "";
        
        btn.innerText = "å„²å­˜ä¸¦åŒæ­¥";
        btn.disabled = false;
        
        // å»¶é²é‡æ•´ä»¥è®€å–æœ€æ–°è³‡æ–™
        setTimeout(loadData, 1500);
    }
</script>
</body>
</html>
