<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯æ±½è»Šç®¡å®¶ PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #1a73e8; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h2 { color: var(--p); text-align: center; margin: 0 0 15px 0; font-size: 1.1rem; }
        label { display: block; margin: 12px 0 5px; font-weight: 600; font-size: 14px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        .btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        
        /* æœå°‹èˆ‡åˆ—è¡¨æ¨£å¼ */
        .search-box { margin-bottom: 15px; position: relative; }
        .search-icon { position: absolute; right: 12px; top: 12px; font-size: 18px; color: #999; }
        .log-list { max-height: 300px; overflow-y: auto; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-item:last-child { border-bottom: none; }
        .log-left { display: flex; flex-direction: column; }
        .log-date { font-size: 12px; color: #888; margin-bottom: 2px; }
        .log-title { font-weight: bold; font-size: 15px; color: #333; }
        .log-right { text-align: right; }
        .log-cost { color: #d93025; font-weight: bold; font-size: 15px; }
        .log-kpl { font-size: 12px; color: var(--p); background: #e8f0fe; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="card">
    <canvas id="fuelChart" style="height: 180px; width: 100%;"></canvas>
    <div id="monthSummary" style="text-align:center; font-weight:bold; color:#d93025; margin-top:10px;"></div>
</div>

<div class="card">
    <h2>ğŸ“ æ–°å¢ç´€éŒ„</h2>
    <input type="date" id="date">
    <div style="display:flex; gap:10px; margin-top:10px;">
        <div style="flex:1;">
            <label>é¡åˆ¥</label>
            <select id="category" onchange="toggleFields()">
                <option value="fuel">â›½ åŠ æ²¹</option>
                <option value="maint">ğŸ› ï¸ ç¶­ä¿®</option>
            </select>
        </div>
        <div style="flex:1;">
            <label>é‡Œç¨‹ (Km)</label>
            <input type="number" id="km" inputmode="numeric">
        </div>
    </div>

    <div id="fuelDiv"><label>å…¬å‡ (L)</label><input type="number" id="amount" step="0.01" inputmode="decimal"></div>
    <div id="maintDiv" style="display:none;"><label>é …ç›®åç¨±</label><input type="text" id="maintName"></div>
    
    <label>é‡‘é¡ ($)</label>
    <input type="number" id="cost" inputmode="numeric">
    
    <button class="btn" onclick="uploadData()" id="saveBtn">å„²å­˜ç´€éŒ„</button>
</div>

<div class="card">
    <h2>ğŸ” æ­·å²æœå°‹</h2>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: æ©Ÿæ²¹, 2026...)" onkeyup="filterLogs()">
        <span class="search-icon">ğŸ”</span>
    </div>
    <div id="logList" class="log-list">
        <div style="text-align:center; color:#999; padding:20px;">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Google Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyapyTQlzO1iN64VWNjvV-LELjgSfABBtDMpjhPJjHalOsNaHVeCE7G_PmKNHFLiRyI/exec";

    let allLogs = []; // å„²å­˜ä¸‹è¼‰ä¸‹ä¾†çš„æ‰€æœ‰æ•¸æ“š
    let myChart = null;

    document.getElementById('date').valueAsDate = new Date();

    window.onload = loadData;

    function toggleFields() {
        const isFuel = document.getElementById('category').value === 'fuel';
        document.getElementById('fuelDiv').style.display = isFuel ? 'block' : 'none';
        document.getElementById('maintDiv').style.display = isFuel ? 'none' : 'block';
    }

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL);
            allLogs = await res.json();
            
            renderLogs(allLogs); // é¡¯ç¤ºåˆ—è¡¨
            renderChart(allLogs); // é¡¯ç¤ºåœ–è¡¨
            
            // æ›´æ–°æœ¬æœˆæ”¯å‡º (å–æœ€æ–°ä¸€ç­†çš„ monthlyTotal)
            if (allLogs.length > 0) {
                document.getElementById('monthSummary').innerHTML = 
                    `æœ¬æœˆç´¯è¨ˆæ”¯å‡ºï¼š$${allLogs[0].monthlyTotal}`;
            }
        } catch (e) {
            console.error("è®€å–å¤±æ•—", e);
            document.getElementById('logList').innerHTML = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
        }
    }

    // æ¸²æŸ“æœå°‹åˆ—è¡¨
    function renderLogs(data) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        if (data.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:10px;'>ç„¡è³‡æ–™</div>";
            return;
        }

        data.forEach(log => {
            const isFuel = log.category === 'åŠ æ²¹';
            const title = isFuel ? 'â›½ åŠ æ²¹' : `ğŸ› ï¸ ${log.name}`;
            const subInfo = isFuel && log.kpl ? `<div class="log-kpl">${log.kpl} Km/L</div>` : '';
            
            list.innerHTML += `
                <div class="log-item">
                    <div class="log-left">
                        <span class="log-date">${log.date}</span>
                        <span class="log-title">${title}</span>
                        ${subInfo}
                    </div>
                    <div class="log-right">
                        <div class="log-cost">$${log.cost}</div>
                        <div style="font-size:12px; color:#aaa;">${log.km}km</div>
                    </div>
                </div>`;
        });
    }

    // æœå°‹åŠŸèƒ½é‚è¼¯
    function filterLogs() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allLogs.filter(log => {
            return (log.name && log.name.toLowerCase().includes(keyword)) || 
                   (log.date.includes(keyword)) ||
                   (log.category.includes(keyword));
        });
        renderLogs(filtered);
    }

    // ç¹ªè£½åœ–è¡¨
    function renderChart(data) {
        // å–å‡ºæœ‰æ²¹è€—ç´€éŒ„çš„è³‡æ–™ (åè½‰å›ä¾†è®Šæˆæ™‚é–“ç”±èˆŠåˆ°æ–°ç•«åœ–)
        const fuelData = [...data].reverse().filter(d => d.kpl && d.kpl !== "");
        const ctx = document.getElementById('fuelChart').getContext('2d');
        
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fuelData.map(d => d.date.substring(5)), // åªé¡¯ç¤º MM-DD
                datasets: [{
                    label: 'æ²¹è€— (Km/L)',
                    data: fuelData.map(d => d.kpl),
                    borderColor: '#1a73e8',
                    tension: 0.3,
                    fill: false
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    async function uploadData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            km: document.getElementById('km').value,
            amount: document.getElementById('amount').value,
            cost: document.getElementById('cost').value,
            name: document.getElementById('maintName').value
        };

        if(!data.km || !data.cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

        btn.disabled = true;
        btn.innerText = "â³ å„²å­˜ä¸­...";

        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        });

        alert("å„²å­˜æˆåŠŸï¼");
        btn.disabled = false;
        btn.innerText = "å„²å­˜ç´€éŒ„";
        
        // æ¸…ç©ºè¼¸å…¥ä¸¦é‡æ–°è¼‰å…¥æ•¸æ“š
        document.getElementById('cost').value = "";
        document.getElementById('amount').value = "";
        setTimeout(loadData, 2000); 
    }
</script>
</body>
</html>
